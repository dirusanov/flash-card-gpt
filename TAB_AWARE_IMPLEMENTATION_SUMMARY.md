# Реализация Tab-Specific Состояний в Chrome Extension

## Что было сделано

### 1. Новая архитектура состояний по вкладкам

- **Создан новый reducer `tabState`** (`src/store/reducers/tabState.ts`):

  - Управляет состоянием карточек отдельно для каждой вкладки
  - Каждая вкладка имеет уникальный префикс для ID полей
  - Хранит свои карточки и данные формы независимо

- **Новые actions для tab-specific операций** (`src/store/actions/tabState.ts`):
  - `setCurrentTabId` - устанавливает активную вкладку
  - `setTabCardField` - обновляет поля карточки для конкретной вкладки
  - `saveTabCard`, `deleteTabCard`, `updateTabStoredCard` - работа с карточками
  - Удобные функции-обертки для каждого поля

### 2. Обновлен background script

- **Отслеживание tab ID** (`src/pages/Background/index.js`):
  - Передает tab ID в content script при переключении sidebar
  - Добавлен endpoint для получения tab ID

### 3. Обновлен content script

- **Tab-aware инициализация** (`src/pages/Content/index.js`):
  - Получает tab ID от background script
  - Передает tab ID в главное приложение
  - Состояние sidebar отдельно для каждой вкладки

### 4. TabAwareProvider контекст

- **Единая точка доступа** (`src/components/TabAwareProvider.tsx`):
  - Автоматически определяет использовать tab-specific или global состояние
  - Предоставляет унифицированный API для компонентов
  - Автоматически загружает сохраненные карточки для вкладки
  - Функция `updateCard` для массового обновления полей

### 5. Обновленное хранилище

- **Tab-specific localStorage** (`src/store/middleware/cardsLocalStorage.ts`):
  - Отдельные ключи хранения для каждой вкладки (`anki_tab_cards_${tabId}`)
  - Автоматическое сохранение при изменениях
  - Совместимость со старой системой

### 6. Обновлены компоненты

- **App.tsx**: Обернут компоненты в TabAwareProvider
- **StoredCards.tsx**: Использует tab-aware контекст
- **CreateCard.tsx**: Частично обновлен для использования tabAware (начальная интеграция)

## Ключевые преимущества

1. **Изолированное состояние**: Каждая вкладка имеет свои карточки и данные формы
2. **Уникальные ID**: Поля в каждой вкладке имеют уникальные префиксы
3. **Автоматическое сохранение**: Данные сохраняются отдельно для каждой вкладки
4. **Обратная совместимость**: Fallback на старую систему если tab state недоступен
5. **Эффективность**: Lazy loading данных только при необходимости

## Что осталось сделать

1. **Полная миграция CreateCard**: Заменить все dispatch(set...) на tabAware.set...
2. **Обновить другие компоненты**: Settings, ResultDisplay и др.
3. **Тестирование**: Проверить работу на различных сценариях
4. **Оптимизация производительности**: Возможные улучшения loading/saving

## Структура файлов

```
src/
├── store/
│   ├── reducers/
│   │   └── tabState.ts (новый)
│   ├── actions/
│   │   └── tabState.ts (новый)
│   └── middleware/
│       └── cardsLocalStorage.ts (обновлен)
├── components/
│   ├── TabAwareProvider.tsx (новый)
│   ├── CreateCard.tsx (частично обновлен)
│   └── StoredCards.tsx (обновлен)
├── pages/
│   ├── Background/index.js (обновлен)
│   └── Content/index.js (обновлен)
└── App.tsx (обновлен)
```

## Использование

Теперь каждая вкладка браузера будет иметь:

- Свое собственное состояние формы создания карточек
- Свой набор сохраненных карточек
- Уникальные ID для всех полей интерфейса
- Независимое localStorage для карточек

Пользователи могут работать с карточками в разных вкладках одновременно без конфликтов.
