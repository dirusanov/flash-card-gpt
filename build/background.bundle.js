(()=>{const e="anki_view_prefs_v1",t=new Map;function o(e){if(!e||null==e.id)return;const t=e.url||"";t.startsWith("http://")||t.startsWith("https://")?(chrome.action.setPopup({tabId:e.id,popup:""}),chrome.action.setTitle({tabId:e.id,title:"Toggle Sidebar / Floating"})):(chrome.action.setPopup({tabId:e.id,popup:"popup.html"}),chrome.action.setTitle({tabId:e.id,title:"\u0420\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u0438\u0435 \u043d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u043d\u043e \u043d\u0430 \u044d\u0442\u043e\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0435"}))}chrome.tabs.onActivated.addListener((({tabId:e})=>chrome.tabs.get(e,o))),chrome.tabs.onUpdated.addListener(((e,t,a)=>{a&&a.active&&("complete"===t.status||t.url)&&o(a)})),chrome.runtime.onInstalled.addListener((()=>{chrome.tabs.query({currentWindow:!0,active:!0},(e=>e[0]&&o(e[0])))})),chrome.action.onClicked.addListener((async t=>{if(!t||null==t.id)return;const o=t.id,a=await new Promise((t=>{try{chrome.storage.local.get([e],(o=>{const a=o[e]||{};t({preferredModeByTab:a.preferredModeByTab||{},visibleByTab:a.visibleByTab||{},floatGeometryByTab:a.floatGeometryByTab||{},globalMode:"float"===a.globalMode?"float":"sidebar",globalVisible:"boolean"!=typeof a.globalVisible||a.globalVisible})}))}catch(e){t({preferredModeByTab:{},visibleByTab:{},floatGeometryByTab:{},globalMode:"sidebar",globalVisible:!0})}})),r=a.preferredModeByTab&&a.preferredModeByTab[o]||a.globalMode||"sidebar",s=a.visibleByTab||{},i=Object.prototype.hasOwnProperty.call(s,o)?!!s[o]:!!a.globalVisible;"float"===r?chrome.tabs.sendMessage(o,{action:i?"hideFloating":"showFloating",tabId:o}):chrome.tabs.sendMessage(o,{action:"toggleSidebar",tabId:o})})),chrome.runtime.onMessage.addListener(((e,o,a)=>{if("string"==typeof e&&e.startsWith("http"))return fetch(e,{method:"GET"}).then((e=>e.blob())).then((e=>new Promise(((t,o)=>{const a=new FileReader;a.onloadend=()=>t(a.result),a.onerror=o,a.readAsDataURL(e)})))).then((e=>a({status:!0,data:e}))).catch((e=>a({status:!1,error:String(e)}))),!0;if(e&&"object"==typeof e){if("proxyFetch"===e.action){const{requestId:o,url:r,options:s={}}=e,i=new AbortController;return t.set(o,i),fetch(r,{method:s.method||"GET",headers:s.headers||{},body:s.body||null,redirect:s.redirect,credentials:s.credentials,signal:i.signal}).then((async e=>{const t={};e.headers.forEach(((e,o)=>{t[o]=e}));const o=await e.text();a({ok:e.ok,status:e.status,statusText:e.statusText,headers:t,body:o})})).catch((e=>{const t=e&&"AbortError"===e.name;a({ok:!1,status:0,statusText:t?"Aborted":"Error",headers:{},body:"",aborted:t,error:t?"Request aborted":String(e)})})).finally((()=>{t.delete(o)})),!0}if("proxyFetchAbort"===e.action){const{requestId:o}=e,r=t.get(o);return r&&(r.abort(),t.delete(o)),a({ok:!1,aborted:!0}),!0}return"getTabId"===e.action?(a({tabId:o.tab?o.tab.id:null}),!0):void 0}}))})();