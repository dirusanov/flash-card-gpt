(()=>{console.log("I am background script");const t=new Map,e=e=>t.get(e)||{floatingVisible:!1},o=(o,r)=>t.set(o,{...e(o),...r}),r=t=>{if(!t||null==t.id)return;const e=t.url||"";e.startsWith("http://")||e.startsWith("https://")?(chrome.action.setPopup({tabId:t.id,popup:""}),chrome.action.setTitle({tabId:t.id,title:"Toggle Sidebar / Floating Window"})):(chrome.action.setPopup({tabId:t.id,popup:"popup.html"}),chrome.action.setTitle({tabId:t.id,title:"\u0420\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u0438\u0435 \u043d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u043d\u043e \u043d\u0430 \u044d\u0442\u043e\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0435"}))},a=()=>{chrome.tabs.query({currentWindow:!0,active:!0},(t=>{chrome.runtime.lastError||r(t[0])}))};chrome.tabs.onActivated.addListener((({tabId:t})=>{chrome.tabs.get(t,(t=>{chrome.runtime.lastError||r(t)}))})),chrome.tabs.onUpdated.addListener(((t,e,o)=>{o&&o.active&&("complete"===e.status||e.url)&&r(o)})),chrome.runtime.onInstalled.addListener((()=>a())),a(),chrome.action.onClicked.addListener((t=>{if(!t||null==t.id)return;const{floatingVisible:r}=e(t.id);if(r)return o(t.id,{floatingVisible:!1}),void chrome.tabs.sendMessage(t.id,{action:"toggleFloating"},(t=>{chrome.runtime.lastError?console.error("toggleFloating(off) error:",chrome.runtime.lastError.message):console.log("toggleFloating off response:",t)}));let a=!1;chrome.tabs.sendMessage(t.id,{action:"toggleFloating"},(e=>{if(chrome.runtime.lastError)return console.warn("toggleFloating error, fallback to sidebar:",chrome.runtime.lastError.message),void chrome.tabs.sendMessage(t.id,{action:"toggleSidebar",tabId:t.id},(t=>{chrome.runtime.lastError?console.error("toggleSidebar error:",chrome.runtime.lastError.message):console.log("toggleSidebar response:",t)}));a=!0,o(t.id,{floatingVisible:!0}),console.log("toggleFloating on response:",e)})),setTimeout((()=>{a||chrome.tabs.sendMessage(t.id,{action:"toggleSidebar",tabId:t.id},(()=>{}))}),150)})),chrome.runtime.onMessage.addListener(((t,r,a)=>{try{if("string"==typeof t&&t.startsWith("http"))return fetch(t,{method:"GET"}).then((t=>t.blob())).then((t=>{const e=new FileReader;e.onloadend=()=>a({status:!0,data:e.result}),e.onerror=t=>a({status:!1,error:String(t)}),e.readAsDataURL(t)})).catch((t=>a({status:!1,error:String(t)}))),!0;if(t&&"getTabId"===t.action){return a({tabId:r?.tab?.id??null}),!0}if(t&&("toggleSidebar"===t.action||"collapseSidebar"===t.action||"expandSidebar"===t.action)){const e=r?.tab?.id??t.tabId;return null==e?(a?.({status:!1,error:"No target tabId"}),!1):(chrome.tabs.sendMessage(e,{action:t.action,tabId:e},(t=>{chrome.runtime.lastError?a?.({status:!1,error:chrome.runtime.lastError.message}):a?.({status:!0,response:t})})),!0)}if(t&&"toggleFloatingFromPage"===t.action){const t=r?.tab?.id;if(null==t)return a?.({ok:!1,error:"No sender.tab.id"}),!1;const{floatingVisible:i}=e(t),n=!i;return o(t,{floatingVisible:n}),chrome.tabs.sendMessage(t,{action:"toggleFloating"},(()=>{})),a?.({ok:!0,floatingVisible:n}),!0}if(t&&"syncFloatingState"===t.action){const e=r?.tab?.id??t.tabId;return null!=e&&"boolean"==typeof t.floatingVisible&&o(e,{floatingVisible:t.floatingVisible}),a?.({ok:!0}),!0}}catch(t){console.error("onMessage handler error:",t);try{a?.({status:!1,error:String(t)})}catch{}}return!1})),console.log("Background script has been loaded.")})();